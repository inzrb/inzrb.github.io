import{b as e,k as r,q as t,K as n,Z as o,c as s,j as i,f as a}from"./r3-other-vendor-2c8fc3cb.js";import{a as l}from"./react-vendor-670efa73.js";import{aE as c}from"./three-vendor-6d04682c.js";import{b as p,d as u}from"./r3-extend-vendor-ed1023dc.js";const d=l.forwardRef((({children:a,renderIndex:d=1,samples:m=64,...v},g)=>{const f=l.useRef(null),h=l.useRef(),{scene:b,controls:y,camera:x,gl:E,size:w,viewport:L}=p();l.useEffect((()=>{h.current=new e({canvas:{getContext:E.getContext,getExtension:E.getExtension},loadingCallback:{onProgress:()=>null,onComplete:()=>null}}),h.current.canvas=E.domElement,h.current.gl=E.getContext();let i=!1;return Array.isArray(a)?(a.forEach(((e,l)=>{if("rectAreaLight"===e.type||"directionalLight"===e.type||"pointLight"===e.type||"sphereAreaLight"===e.type){const s=e.props.color?e.props.color:"#fff",i=e.props.intensity?e.props.intensity:1,c=e.props.radius?e.props.radius:1,p=e.props.width?e.props.width:1,u=e.props.height?e.props.height:1;let d={rectAreaLight:new r(s,i,p,u),directionalLight:new t(s,i),pointLight:new n(s,i),sphereAreaLight:new o(s,i,c)}[e.type];const m=e.props.position?e.props.position:[0,0,0],v=e.props.target?e.props.target:[0,0,0];d.position.set(m[0],m[1],m[2]),"rectAreaLight"!==e.type&&"directionalLight"!==e.type||d.target.set(v[0],v[1],v[2]),f.current.add(d),a=Array.from(a).splice(l,1)}else if("Environment"===e.type.name||"HO"===e.type.name||e.props.files){i=!0;const r=e.props.files,t=(new s).setDataType(c).load(r,(()=>{}));f.current.environment=t,h.current.enviromentVisible=!1,a=Array.from(a).splice(l,1)}})),i||(h.current.enviromentVisible=!!b.background,f.current.environment=b.environment),h.current.needsUpdate=!0,h.current.pipeline&&h.current.render(f.current,x)):(h.current.enviromentVisible=!!b.background,f.current.environment=b.environment),()=>{h.current.canvas=null,h.current.gl=null,h.current.pipeline=null}}),[]);const C=l.useCallback((()=>{h.current&&(h.current.needsUpdate=!0,h.current.pipeline&&h.current.render(f.current,x))}),[]);return l.useEffect((()=>{const{denoiseColorBlendFactor:e,denoiseMomentBlendFactor:r,denoiseColorFactor:t,denoisePositionFactor:n,...o}=v;Object.assign(h.current,o),void 0!==e&&h.current.setDenoiseColorBlendFactor(e),void 0!==r&&h.current.setDenoiseMomentBlendFactor(r),void 0!==t&&h.current.setDenoiseColorFactor(t),void 0!==n&&h.current.setDenoisePositionFactor(n),C()}),[v]),l.useEffect((()=>{if(y)return y.addEventListener("start",C),()=>y.removeEventListener("start",C)}),[y]),l.useEffect((()=>{h.current.setSize(w.width,w.height),h.current.setPixelRatio(L.dpr),C()}),[w,L]),l.useEffect((()=>{h.current.buildScene(f.current,x).then(C)}),[]),l.useImperativeHandle(g,(()=>h.current),[]),u((()=>{h.current&&h.current.pipeline&&h.current.getTotalSamples()<m&&h.current.render(f.current,x)}),d),i.jsx("scene",{ref:f,children:a})})),m={movingDownsampling:{value:!0,label:"移动过程中降低采样"},useTileRenderer:{value:!1,label:"使用Tile渲染器"},samples:{value:32,min:8,max:256,step:4,label:"采样"},bounces:{value:1,min:1,max:10,step:1,label:"反弹次数"},envMapIntensity:{value:1,min:0,max:3,label:"环境纹理亮度"},denoise:a({enableDenoise:{value:!0,label:"开启降噪"},enableTemporalDenoise:{value:!0,label:"开启实时降噪"},enableSpatialDenoise:{value:!0,label:"开启立体空间降噪"}})};export{d as R,m as c};
