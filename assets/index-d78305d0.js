import{q as e,r as t,G as s}from"./vendor-89444a7f.js";import{aw as r,br as a,bs as n,bt as o,bu as i,bv as u,bw as c,l,bx as d,by as m,bz as f,az as p,a as h,bh as g,bk as b,bb as x,aF as j,aG as v}from"./vendor_three-3a2bdf96.js";let w=!0,k=2.5,y=.1,M=1;window.devicePixelRatio;const F=e.createContext(null);function C({alpha:e=1,samples:g=1,frames:b=1/0,tiles:x=2,bounces:j=1,enabled:v=!0,resolutionFactor:C=1,backgroundBlur:E=0,backgroundIntensity:I=1,children:A}){const R=t.useRef(null),S=r((e=>e.gl)),z=r((e=>e.size)),P=r((e=>e.viewport)),G=r((e=>e.camera)),B=r((e=>e.scene)),L=t.useMemo((()=>new a),[]),N=t.useMemo((()=>new n),[]),H=t.useMemo((()=>{const e=new o(S);return e.frames=0,e.alpha=!0,e}),[S]);t.useEffect((()=>{if(N.envMapInfo=new i,N.backgroundMap=null,B.background instanceof u)N.envMapInfo.updateFrom(B.background);else{if(B.environment instanceof u){N.envMapInfo.updateFrom(B.environment);const e=new c;e.topColor.set(0),e.bottomColor.set(0),e.update(),N.backgroundMap=e}if(B.background instanceof l){const e=new c;e.topColor.set(B.background.getHex()),e.bottomColor.set(B.background.getHex()),e.update(),N.backgroundMap=e}else B.background instanceof c&&(N.backgroundMap=B.background)}}),[N,B.background,B.environment]);const W=t.useMemo((()=>new d(new m({map:H.target.texture,blending:f,premultipliedAlpha:S.getContextAttributes().premultipliedAlpha}))),[]);t.useEffect((()=>{N.bounces=j}),[N,j]),t.useEffect((()=>{N.backgroundBlur=E}),[N,E]),t.useEffect((()=>{N.backgroundAlpha=e}),[N,e]),t.useEffect((()=>{N.environmentIntensity=I}),[N,I]),t.useEffect((()=>{H.setSize(z.width*C*P.dpr,z.height*C*P.dpr),H.reset()}),[H,z,C]),t.useEffect((()=>{H.camera=G}),[H,G]),t.useEffect((()=>{H.material=N}),[H,N]),t.useEffect((()=>{H.alpha=e<1}),[H,e]),t.useEffect((()=>{const e=(t=x,Array.isArray(t)?t:t instanceof h?[t.x,t.y]:"number"==typeof t?[t,t]:[t.x,t.y]);var t;H.tiles.set(e[0],e[1]),H.stableNoise=w,W.material.sigma=k,W.material.threshold=y,W.material.kSigma=M}),[H,x]);const $=t.useMemo((()=>({update:()=>{const e=R.current,{bvh:t,textures:s,materials:r,lights:a}=L.generate(e);console.log(r,a);const n=t.geometry,o=H.material;N.bvh.updateFrom(t),o.bvh.updateFrom(t),o.attributesArray.updateFrom(n.attributes.normal,n.attributes.tangent,n.attributes.uv,n.attributes.color),o.materialIndexAttribute.updateFrom(n.attributes.materialIndex),o.textures.setTextures(S,2048,2048,s),o.materials.updateFrom(r,s),N.lights.updateFrom(a),H.material.lights.updateFrom(a)},reset:()=>{H.reset(),H.frames=0},renderer:H})),[N,L,S]);return t.useEffect((()=>{B.updateMatrixWorld(),$.update(),$.reset()}),[]),p((({camera:e,gl:t,scene:s})=>{if(e.updateMatrixWorld(),v&&H.frames<b){for(let e=0;e<g;e++)H.update();H.frames++}H.samples<1&&t.render(s,e),t.autoClear=!1,W.material.map=H.target.texture,W.render(t),t.autoClear=!0}),1),s.jsx(F.Provider,{value:$,children:s.jsx("group",{ref:R,children:A})})}function E(){const e=t.useContext(F);if(!e)throw new Error("usePathtracer must be used within a Pathtracing");return e}const I=()=>{const{reset:e}=E();return s.jsxs(s.Fragment,{children:[s.jsx(g,{onChange:()=>e(),makeDefault:!0}),s.jsx(A,{})]})};function A(){return s.jsxs("group",{position:[0,-.25,0],children:[s.jsx(R,{position:[0,-.5,0]}),s.jsxs("mesh",{position:[0,0,-1],scale:.5,children:[s.jsx("sphereGeometry",{args:[1,64,64]}),s.jsx(b,{transmission:1,resolution:1024,distortion:.25,color:"#fff",thickness:0,roughness:0})]}),s.jsxs("mesh",{castShadow:!0,receiveShadow:!0,position:[1,.25,1],children:[s.jsx("sphereGeometry",{args:[.75,32,32]}),s.jsx(b,{color:"red",transmission:1,thickness:2,roughness:0})]}),s.jsx("directionalLight",{intensity:3,color:"#fff"}),s.jsx("pointLight",{args:[0,0,3],color:"#f00"}),s.jsx("rectAreaLight",{args:["white",3],width:5,height:5,position:[-3,4,1],target:[0,0,0],visible:!1})]})}function R(e){const{nodes:t,materials:r}=x("/models/ruby.glb");return s.jsx("group",{...e,dispose:null,children:s.jsx("mesh",{castShadow:!0,receiveShadow:!0,geometry:t.Ruby_0.geometry,rotation:[-Math.PI/2,0,0],children:s.jsx(b,{transmission:1,roughness:0,clearcoat:1,clearcoatRoughness:0,color:"orange"})})})}function S({infoRef:e}){const{renderer:t}=E();return p((()=>{e.current&&(e.current.children[0].textContent=`${t.frames} frames`,e.current.children[1].textContent=`${t.samples} samples`)}),[]),null}const z=()=>{const e=t.useRef();return s.jsxs("div",{className:"page",children:[s.jsx(j,{shadows:!0,camera:{position:[0,.1,5],fov:45,near:1,far:20},gl:{toneMapping:v},children:s.jsxs(C,{samples:1,bounces:2,resolutionFactor:1,tiles:1,enabled:!0,frames:20,backgroundIntensity:1,backgroundBlur:.2,children:[s.jsx(I,{}),s.jsx(S,{infoRef:e})]})}),s.jsxs("div",{className:"info",ref:e,style:{position:"absolute",left:"0",top:"0",zIndex:"111",color:"red"},children:[s.jsx("p",{children:"0 frames"}),s.jsx("p",{children:"0 samples"})]})]})};export{z as default};
